# GitNut Nginx server blocks (example)
#
# Replace domains and certificate paths to match your environment.
#
# Upstreams (adjust hostnames/ports):
upstream gitnut_web {
  server web:3000;
  keepalive 32;
}

upstream gitnut_api {
  server api:8080;
  keepalive 32;
}

upstream gitnut_grafana {
  server grafana:3000;
  keepalive 16;
}

# HTTP -> HTTPS redirect
server {
  listen 80;
  listen [::]:80;
  server_name gitnut.example.com api.gitnut.example.com grafana.gitnut.example.com;
  return 301 https://$host$request_uri;
}

# WEB
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name gitnut.example.com;

  # ssl_certificate     /etc/ssl/certs/fullchain.pem;
  # ssl_certificate_key /etc/ssl/private/privkey.pem;
  include /etc/nginx/snippets/ssl.conf;

  include /etc/nginx/snippets/security.conf;

  location / {
    include /etc/nginx/snippets/proxy.conf;
    proxy_pass http://gitnut_web;
  }
}

# API
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name api.gitnut.example.com;

  # ssl_certificate     /etc/ssl/certs/fullchain.pem;
  # ssl_certificate_key /etc/ssl/private/privkey.pem;
  include /etc/nginx/snippets/ssl.conf;

  include /etc/nginx/snippets/security.conf;

  location / {
    include /etc/nginx/snippets/proxy.conf;
    proxy_pass http://gitnut_api;
  }
}

# Grafana (optional)
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name grafana.gitnut.example.com;

  # ssl_certificate     /etc/ssl/certs/fullchain.pem;
  # ssl_certificate_key /etc/ssl/private/privkey.pem;
  include /etc/nginx/snippets/ssl.conf;

  include /etc/nginx/snippets/security.conf;

  location / {
    include /etc/nginx/snippets/proxy.conf;
    proxy_pass http://gitnut_grafana;
  }
}
