{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://gitnut.dev/schemas/source-attestation.v1.json",
  "title": "source-attestation.v1",
  "description": "Attestation that binds a repository source snapshot to a deterministic archive and hash.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "type",
    "issuedAt",
    "subject",
    "claims",
    "signature"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "enum": [
        "1.0.0"
      ]
    },
    "type": {
      "type": "string",
      "const": "source-attestation"
    },
    "issuedAt": {
      "type": "string",
      "format": "date-time"
    },
    "issuer": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 3,
          "maxLength": 200
        },
        "name": {
          "type": "string",
          "maxLength": 200
        },
        "publicKey": {
          "type": "string",
          "description": "Ed25519 public key as base58 string.",
          "minLength": 32,
          "maxLength": 64
        },
        "wallet": {
          "type": "string",
          "description": "Solana public key as base58 string.",
          "minLength": 32,
          "maxLength": 64
        },
        "url": {
          "type": "string",
          "format": "uri",
          "minLength": 1
        }
      }
    },
    "subject": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "projectSlug",
        "version"
      ],
      "properties": {
        "projectSlug": {
          "type": "string",
          "pattern": "^[a-z0-9]+(?:-[a-z0-9]+){0,39}$"
        },
        "version": {
          "type": "string",
          "description": "Semantic Versioning string.",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
        },
        "source": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "provider": {
              "type": "string",
              "enum": [
                "github",
                "gitlab",
                "bitbucket",
                "generic"
              ]
            },
            "repo": {
              "type": "string",
              "minLength": 3,
              "maxLength": 200
            },
            "ref": {
              "type": "string",
              "maxLength": 200
            },
            "commit": {
              "type": "string",
              "pattern": "^[a-f0-9]{40}$"
            },
            "subdir": {
              "type": "string",
              "maxLength": 500
            }
          }
        }
      }
    },
    "claims": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "sourceArchive",
        "files",
        "tree"
      ],
      "properties": {
        "sourceArchive": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "format",
            "sha256",
            "sizeBytes"
          ],
          "properties": {
            "format": {
              "type": "string",
              "enum": [
                "tar.gz",
                "zip"
              ]
            },
            "sha256": {
              "type": "string",
              "description": "Lowercase hex SHA-256 digest.",
              "pattern": "^[a-f0-9]{64}$"
            },
            "sizeBytes": {
              "type": "integer",
              "minimum": 0
            },
            "uri": {
              "type": "string",
              "format": "uri",
              "minLength": 1
            }
          }
        },
        "tree": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "algorithm",
            "hash"
          ],
          "properties": {
            "algorithm": {
              "type": "string",
              "enum": [
                "git-tree",
                "merkle-sha256"
              ]
            },
            "hash": {
              "type": "string",
              "minLength": 16,
              "maxLength": 128
            },
            "nodeCount": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "files": {
          "type": "array",
          "maxItems": 200000,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "path",
              "sha256",
              "sizeBytes"
            ],
            "properties": {
              "path": {
                "type": "string",
                "minLength": 1,
                "maxLength": 2000
              },
              "sha256": {
                "type": "string",
                "description": "Lowercase hex SHA-256 digest.",
                "pattern": "^[a-f0-9]{64}$"
              },
              "sizeBytes": {
                "type": "integer",
                "minimum": 0
              },
              "mode": {
                "type": "string",
                "pattern": "^[0-7]{3,4}$"
              },
              "isSymlink": {
                "type": "boolean"
              },
              "symlinkTarget": {
                "type": "string",
                "maxLength": 4000
              }
            }
          }
        },
        "exclusions": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 2000
          },
          "maxItems": 5000
        }
      }
    },
    "signature": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "alg",
        "value",
        "payloadHash"
      ],
      "properties": {
        "alg": {
          "type": "string",
          "enum": [
            "ed25519"
          ]
        },
        "value": {
          "type": "string",
          "description": "Signature value as base64.",
          "minLength": 16,
          "maxLength": 512
        },
        "payloadHash": {
          "type": "string",
          "description": "Lowercase hex SHA-256 digest.",
          "pattern": "^[a-f0-9]{64}$"
        }
      }
    },
    "links": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "canonicalJson": {
          "type": "string",
          "format": "uri",
          "minLength": 1
        },
        "bundle": {
          "type": "string",
          "format": "uri",
          "minLength": 1
        },
        "docs": {
          "type": "string",
          "format": "uri",
          "minLength": 1
        }
      }
    }
  },
  "defs": {
    "semver": {
      "type": "string",
      "description": "Semantic Versioning string.",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
    },
    "sha256": {
      "type": "string",
      "description": "Lowercase hex SHA-256 digest.",
      "pattern": "^[a-f0-9]{64}$"
    },
    "ed25519PublicKey": {
      "type": "string",
      "description": "Ed25519 public key as base58 string.",
      "minLength": 32,
      "maxLength": 64
    },
    "solanaPubkey": {
      "type": "string",
      "description": "Solana public key as base58 string.",
      "minLength": 32,
      "maxLength": 64
    },
    "uri": {
      "type": "string",
      "format": "uri",
      "minLength": 1
    },
    "datetime": {
      "type": "string",
      "format": "date-time"
    }
  }
}